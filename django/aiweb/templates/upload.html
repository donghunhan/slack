<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOv8 객체 감지</title>
</head>
<body>
    <h1>YOLOv8 객체 감지</h1>
    
    <!-- 파일 업로드 폼 -->
    <form id="upload-form" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" id="file-input" name="file" accept="image/*,video/*" required>
        <button type="submit">업로드 및 분석</button>
    </form>

    <h2>분석 결과</h2>

    <!-- 이미지 결과 -->
    <img id="result-image" src="" alt="YOLOv8 결과" style="display: none; max-width: 100%;">

    <!-- 동영상 결과 -->
    <div id="result-video" style="display: none;">
        <video id="video-player" controls style="max-width: 100%;"></video>
    </div>

    <script>
        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault(); // 기본 폼 제출 동작 방지
            
            var formData = new FormData();
            var fileInput = document.getElementById('file-input');

            if (!fileInput.files[0]) {
                alert("파일을 선택하세요.");
                return;
            }

            formData.append('file', fileInput.files[0]);

            // CSRF 토큰 가져오기
            var csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'upload_file' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken  // CSRF 토큰 추가
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result_image) {
                    // 이미지 결과 표시
                    document.getElementById('result-image').src = "data:image/jpeg;base64," + data.result_image;
                    document.getElementById('result-image').style.display = "block";
                    document.getElementById('result-video').style.display = "none";
                } else if (data.result_video) {
                    // 동영상 결과 표시
                    var videoPlayer = document.getElementById('video-player');
                    videoPlayer.src = "data:video/mp4;base64," + data.result_video[0];  // 첫 번째 프레임을 예시로 사용
                    videoPlayer.style.display = "block";
                    document.getElementById('result-image').style.display = "none";
                } else {
                    alert("파일 처리 실패!");
                }
            })
            .catch(error => {
                console.error("오류 발생:", error);
                alert("파일 분석 중 오류가 발생했습니다.");
            });
        });
    </script>
</body>
</html>
